<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>即刻译 偏好设置</title>
    <style>
      :root {
        color-scheme: dark;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #17191e;
        color: #eef2f8;
      }

      .layout {
        display: flex;
        min-height: 100vh;
      }

      .sidebar {
        width: 210px;
        padding: 22px 14px;
        border-right: 1px solid #2f3540;
        background: #13161b;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 18px;
      }

      .brand-icon {
        width: 22px;
        height: 22px;
        border-radius: 7px;
        box-shadow: 0 4px 12px rgba(46, 113, 255, 0.28);
      }

      .nav-item {
        width: 100%;
        border: 0;
        padding: 10px 12px;
        border-radius: 10px;
        color: #9fb1c8;
        margin-bottom: 8px;
        background: #1a1f27;
        text-align: left;
        cursor: pointer;
      }

      .nav-item.active {
        color: #dbeafe;
        background: #1f2c44;
      }

      .content {
        flex: 1;
        padding: 24px;
        overflow: auto;
      }

      .sticky-actions {
        position: sticky;
        top: -2px;
        z-index: 8;
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 14px;
        padding: 10px 12px;
        border: 1px solid #313947;
        border-radius: 10px;
        background: rgba(20, 25, 34, 0.95);
        backdrop-filter: blur(4px);
      }

      .panel {
        background: #1b2028;
        border: 1px solid #2f3540;
        border-radius: 12px;
        padding: 16px;
      }

      .pref-section {
        display: none;
      }

      .pref-section.active {
        display: block;
      }

      .panel h2 {
        margin: 0 0 8px;
        font-size: 16px;
      }

      .hint {
        margin: 0 0 14px;
        font-size: 12px;
        color: #9fb1c8;
      }

      .service-layout {
        display: grid;
        grid-template-columns: 260px 1fr;
        gap: 14px;
      }

      .service-list {
        border: 1px solid #313947;
        border-radius: 10px;
        background: #141922;
        min-height: 300px;
        max-height: 460px;
        overflow: auto;
        padding: 8px;
      }

      .service-item {
        width: 100%;
        border: 1px solid #2f3a4a;
        border-radius: 10px;
        background: #1a202b;
        color: #d7e2f4;
        margin-bottom: 8px;
        padding: 10px;
        text-align: left;
        cursor: pointer;
      }

      .service-item.active {
        border-color: #2563eb;
        background: #1b2a45;
      }

      .service-item-title {
        font-size: 13px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .service-item-meta {
        margin-top: 6px;
        font-size: 12px;
        color: #92a4bf;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .tag {
        display: inline-flex;
        align-items: center;
        height: 20px;
        padding: 0 8px;
        border-radius: 999px;
        font-size: 11px;
      }

      .tag.primary {
        color: #dbeafe;
        background: rgba(37, 99, 235, 0.25);
        border: 1px solid rgba(59, 130, 246, 0.55);
      }

      .tag.warn {
        color: #fcd34d;
        background: rgba(217, 119, 6, 0.18);
        border: 1px solid rgba(217, 119, 6, 0.55);
      }

      .service-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }

      .service-editor {
        border: 1px solid #313947;
        border-radius: 10px;
        background: #141922;
        padding: 12px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(220px, 1fr));
        gap: 12px;
      }

      .single-line {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
      }

      label {
        display: block;
        font-size: 12px;
        color: #9fb1c8;
        margin-bottom: 6px;
      }

      input[type='text'],
      input[type='password'],
      input[type='number'],
      select,
      textarea {
        width: 100%;
        border-radius: 8px;
        border: 1px solid #3a4352;
        background: #10141a;
        color: #eef2f8;
      }

      input[type='text'],
      input[type='password'],
      input[type='number'],
      select {
        height: 36px;
        padding: 0 10px;
      }

      textarea {
        min-height: 180px;
        padding: 10px;
        resize: vertical;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono',
          'Courier New', monospace;
        line-height: 1.45;
      }

      input[type='checkbox'] {
        transform: scale(1.1);
      }

      .subpanel {
        margin-top: 14px;
        padding-top: 14px;
        border-top: 1px solid #313947;
      }

      .toggle-list {
        display: grid;
        grid-template-columns: repeat(2, minmax(220px, 1fr));
        gap: 10px;
      }

      .toggle-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #d7e2f4;
        font-size: 13px;
        margin: 0;
      }

      .bubble-service-list {
        border: 1px solid #313947;
        border-radius: 10px;
        background: #101723;
        padding: 10px;
        display: grid;
        grid-template-columns: repeat(2, minmax(180px, 1fr));
        gap: 8px 12px;
      }

      .bubble-service-item {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #d7e2f4;
        min-width: 0;
      }

      .bubble-service-item-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .small-hint {
        margin: 8px 0 0;
        font-size: 12px;
        color: #8ea5c3;
      }

      .subpanel-title {
        margin: 0 0 10px;
        font-size: 14px;
        font-weight: 700;
        color: #dbe7fb;
      }

      .automation-list {
        border: 1px solid #313947;
        border-radius: 10px;
        background: #141922;
        overflow: hidden;
      }

      .automation-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 11px 12px;
        border-bottom: 1px solid #2a3140;
      }

      .automation-item:last-child {
        border-bottom: 0;
      }

      .automation-item-main {
        display: flex;
        flex-direction: column;
        gap: 3px;
        min-width: 0;
      }

      .automation-item-title {
        font-size: 13px;
        color: #d8e3f6;
      }

      .automation-item-note {
        font-size: 12px;
        color: #90a2bc;
      }

      .shortcut-input {
        cursor: default;
      }

      .shortcut-input:focus {
        border-color: #60a5fa;
        box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.22);
        outline: none;
      }

      .shortcut-hint {
        margin: 8px 0 0;
        font-size: 12px;
        color: #7fa6cf;
      }

      .field-with-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .field-with-actions > input {
        flex: 1;
      }

      .field-action-btn {
        width: auto;
        min-width: 54px;
        height: 32px;
        padding: 0 10px;
        border: 1px solid #3a4352;
        border-radius: 8px;
        color: #c9d8ef;
        background: #1a2230;
      }

      .field-action-btn:hover {
        background: #233148;
      }

      .actions {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 16px;
      }

      button {
        border: 0;
        border-radius: 8px;
        height: 36px;
        padding: 0 14px;
        cursor: pointer;
        color: #eef2f8;
        background: #293244;
      }

      button.primary {
        background: #2563eb;
      }

      button.warn {
        background: #7f1d1d;
      }

      button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      #status {
        font-size: 12px;
        color: #9fb1c8;
      }

      #effectiveSummary {
        font-size: 12px;
        color: #9fb1c8;
      }

      #settingsPath {
        color: #7dd3fc;
      }

      @media (max-width: 1100px) {
        .service-layout {
          grid-template-columns: 1fr;
        }

        .grid {
          grid-template-columns: 1fr;
        }

        .bubble-service-list {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <div class="brand">
          <img class="brand-icon" src="./assets/jikeyi-logo.svg" alt="即刻译" />
          <span>即刻译</span>
        </div>
        <button class="nav-item active" data-section-target="services" type="button">服务管理</button>
        <button class="nav-item" data-section-target="ui" type="button">快捷键与界面</button>
        <button class="nav-item" data-section-target="file" type="button">配置文件</button>
      </aside>

      <main class="content">
        <div class="sticky-actions">
          <button id="saveBtn" class="primary" type="button">保存并立即生效</button>
          <button id="openRawBtn" type="button">打开原始 JSON</button>
          <span id="status">等待操作</span>
        </div>

        <section class="panel pref-section active" data-section-id="services">
          <h2>服务</h2>
          <p class="hint">可配置多个翻译服务（URL / API Key / Model 互不干扰），并选择一个当前生效服务。</p>
          <div class="service-layout">
            <div>
              <div id="serviceList" class="service-list"></div>
              <div class="service-actions">
                <button id="addServiceBtn" type="button">新增服务</button>
                <button id="removeServiceBtn" class="warn" type="button">删除当前</button>
              </div>
            </div>

            <div class="service-editor">
              <div class="single-line">
                <input id="serviceEnabled" type="checkbox" />
                <label for="serviceEnabled" style="margin: 0">启用该服务</label>
                <span id="activeTag" class="tag primary">当前生效</span>
                <button id="setActiveBtn" type="button">设为当前服务</button>
              </div>

              <div class="grid">
                <div>
                  <label for="serviceName">服务名称</label>
                  <input id="serviceName" type="text" />
                </div>
                <div>
                  <label for="serviceModel">模型（ANTHROPIC_MODEL）</label>
                  <input id="serviceModel" type="text" />
                </div>
                <div>
                  <label for="serviceBaseUrl">接口地址（ANTHROPIC_BASE_URL）</label>
                  <input id="serviceBaseUrl" type="text" />
                </div>
                <div>
                  <label for="serviceApiKey">API Key（ANTHROPIC_AUTH_TOKEN）</label>
                  <div class="field-with-actions">
                    <input id="serviceApiKey" type="password" autocomplete="off" spellcheck="false" />
                    <button id="serviceApiKeyPasteBtn" class="field-action-btn" type="button">粘贴</button>
                    <button id="serviceApiKeyCopyBtn" class="field-action-btn" type="button">复制</button>
                  </div>
                </div>
                <div>
                  <label for="serviceTargetLanguage">目标语言（TARGET_LANGUAGE）</label>
                  <input id="serviceTargetLanguage" type="text" />
                </div>
                <div>
                  <label for="serviceTimeoutMs">超时（API_TIMEOUT_MS）</label>
                  <input id="serviceTimeoutMs" type="number" min="1000" />
                </div>
              </div>

              <div class="subpanel">
                <div class="toggle-list">
                  <label class="toggle-item" for="autoRouteEnabled">
                    <input id="autoRouteEnabled" type="checkbox" />
                    自动路由（按历史延迟/错误率选择主服务）
                  </label>
                </div>
                <div style="margin-top: 12px">
                  <label>气泡模式显示结果服务</label>
                  <div id="bubbleServiceList" class="bubble-service-list"></div>
                  <p class="small-hint">
                    仅在 bubble 模式生效。若全部取消，将自动显示全部启用服务，避免气泡空白。
                  </p>
                </div>
                <div style="margin-top: 12px">
                  <label for="glossaryInput">术语表（每行一个：原词 => 译法）</label>
                  <textarea
                    id="glossaryInput"
                    placeholder="RAG => 检索增强生成&#10;prompt injection => 提示词注入"
                  ></textarea>
                  <p class="small-hint">
                    支持分隔符：<code>=></code>、<code>-></code>、<code>=</code>、<code>：</code>。空行会自动忽略。
                  </p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="panel pref-section" data-section-id="ui">
          <h2>快捷键与界面</h2>
          <p class="hint">快捷键录制：点击输入框后按组合键。</p>
          <div class="grid">
            <div>
              <label for="translateShortcut">TRANSLATE_SHORTCUT</label>
              <input id="translateShortcut" class="shortcut-input" type="text" readonly />
              <p class="shortcut-hint">按 Delete / Backspace 清空</p>
            </div>
            <div>
              <label for="openSettingsShortcut">OPEN_SETTINGS_SHORTCUT</label>
              <input id="openSettingsShortcut" class="shortcut-input" type="text" readonly />
              <p class="shortcut-hint">例如：CommandOrControl+Shift+O</p>
            </div>
            <div>
              <label for="popupMode">POPUP_MODE</label>
              <select id="popupMode">
                <option value="panel">panel（大窗双栏）</option>
                <option value="bubble">bubble（贴边小气泡）</option>
              </select>
            </div>
            <div>
              <label for="fontSize">TRANSLATOR_FONT_SIZE（12-32）</label>
              <input id="fontSize" type="number" min="12" max="32" step="1" />
            </div>
          </div>
          <div class="subpanel">
            <h3 class="subpanel-title">自动化处理</h3>
            <div class="automation-list">
              <label class="automation-item" for="replaceLineBreaksWithSpace">
                <span class="automation-item-main">
                  <span class="automation-item-title">将翻译原文的「换行符」替换为「空格」</span>
                  <span class="automation-item-note">适合 OCR/PDF 断行较多的文本。</span>
                </span>
                <input id="replaceLineBreaksWithSpace" type="checkbox" />
              </label>

              <label class="automation-item" for="stripCodeCommentMarkers">
                <span class="automation-item-main">
                  <span class="automation-item-title">将翻译原文中的注释符号（/* */ // #）去掉</span>
                  <span class="automation-item-note">只做轻量清洗，不改动正文语义。</span>
                </span>
                <input id="stripCodeCommentMarkers" type="checkbox" />
              </label>

              <label class="automation-item" for="removeHyphenSpace">
                <span class="automation-item-main">
                  <span class="automation-item-title">将翻译原文中的「- 空格」断词连接回去</span>
                  <span class="automation-item-note">示例：insignif- icant -> insignificant。</span>
                </span>
                <input id="removeHyphenSpace" type="checkbox" />
              </label>

              <label class="automation-item" for="autoCopyOcrResult">
                <span class="automation-item-main">
                  <span class="automation-item-title">自动复制截图翻译 OCR 结果</span>
                  <span class="automation-item-note">当前版本预留，接入 OCR 流程后自动生效。</span>
                </span>
                <input id="autoCopyOcrResult" type="checkbox" />
              </label>

              <label class="automation-item" for="autoCopyFirstResult">
                <span class="automation-item-main">
                  <span class="automation-item-title">自动复制首个翻译结果</span>
                  <span class="automation-item-note">每次翻译任务仅自动复制一次。</span>
                </span>
                <input id="autoCopyFirstResult" type="checkbox" />
              </label>

              <label class="automation-item" for="copyHighlightedWordOnClick">
                <span class="automation-item-main">
                  <span class="automation-item-title">点击译文中的英文单词时自动复制</span>
                  <span class="automation-item-note">便于快速查词或粘贴到其它工具。</span>
                </span>
                <input id="copyHighlightedWordOnClick" type="checkbox" />
              </label>

              <label class="automation-item" for="autoPlaySourceText">
                <span class="automation-item-main">
                  <span class="automation-item-title">自动播放翻译原文</span>
                  <span class="automation-item-note">使用系统语音播放本次待翻译文本。</span>
                </span>
                <input id="autoPlaySourceText" type="checkbox" />
              </label>
            </div>
          </div>
          <p id="effectiveSummary">当前生效配置：加载中...</p>
        </section>

        <section class="panel pref-section" data-section-id="file">
          <h2>配置文件</h2>
          <p class="hint">当前配置路径：<span id="settingsPath">加载中...</span></p>
        </section>
      </main>
    </div>

    <script src="./preferences.js"></script>
  </body>
</html>
