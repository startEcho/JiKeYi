# 即刻译发布与上线操作手册（macOS 独立分发）

本文档针对当前 Swift 项目（非 App Store）发布流程，覆盖：
- 每一步要做什么
- 每一步是干什么的
- 大概耗时
- 产出物和验收标准

适用项目路径：`/Volumes/PSSD/工具/trans`

---

## 0. 你当前项目的现状（已具备）

项目已提供可用脚本：
- 打包 App：`/Volumes/PSSD/工具/trans/scripts/package-macos-app.sh`
- 发布签名+公证+DMG：`/Volumes/PSSD/工具/trans/scripts/release-macos.sh`

这意味着你不需要从零搭建发布流水线，只要补齐 Apple 证书和公证配置即可进入可分发状态。

---

## 1. 首次发布前的一次性准备

> 这部分只做一次。首次通常 2-4 小时（含证书申请、权限配置等待）。

| 步骤 | 目的 | 预计耗时 | 完成标准 |
| --- | --- | --- | --- |
| 1. 加入 Apple Developer Program | 获得 Developer ID 签名与公证资格 | 30-120 分钟（含账号审核不确定性） | 账号可在 Apple Developer 中看到 Team ID |
| 2. 安装 Developer ID Application 证书 | 让 macOS 认可你的发布身份 | 15-30 分钟 | `security find-identity -v -p codesigning` 能看到 `Developer ID Application` |
| 3. 配置 notarytool keychain profile | 让脚本能自动提交公证 | 10-20 分钟 | `xcrun notarytool history --keychain-profile <profile>` 可返回结果 |
| 4. 确认 Bundle ID / 版本策略 | 让每次发布可追溯 | 10-20 分钟 | 明确 `BUNDLE_ID`、`APP_VERSION`、`BUILD_NUMBER` 规则 |
| 5. 准备发布素材 | 用于下载页/Release 页面 | 30-60 分钟 | 有更新说明、截图、已知问题说明 |

### 1.1 配置 notarytool（一次性）

```bash
xcrun notarytool store-credentials "AC_NOTARY" \
  --apple-id "你的AppleID邮箱" \
  --team-id "你的TEAMID" \
  --password "你的App专用密码"
```

作用：把公证凭据安全存入钥匙串，后续脚本直接引用 `AC_NOTARY`。

---

## 2. 每次发布的标准流程（建议照单执行）

> 典型单次发布耗时：45-120 分钟（取决于公证排队时间与回归测试范围）。

### Step A：发布前冻结与版本确认

**做什么**
- 确认本次发布版本号，例如 `1.1.0`
- 确认 Build Number（建议用时间戳）
- 准备发布说明（新增/修复/已知问题）

**为什么**
- 版本可追溯，用户可区分是否已升级

**预计耗时**
- 10-20 分钟

---

### Step B：本地构建与冒烟检查

**做什么**

```bash
cd /Volumes/PSSD/工具/trans
swift build
swift build -c release
```

**为什么**
- 先确认代码可编译，避免把失败构建送去签名/公证

**预计耗时**
- 5-20 分钟

**验收标准**
- Debug/Release 都成功

---

### Step C：执行正式发布脚本（签名+公证+DMG）

**做什么**

```bash
cd /Volumes/PSSD/工具/trans
APP_VERSION="1.1.0" \
BUILD_NUMBER="$(date +%Y%m%d%H%M)" \
SIGN_IDENTITY="Developer ID Application: 你的公司或姓名 (TEAMID)" \
KEYCHAIN_PROFILE="AC_NOTARY" \
./scripts/release-macos.sh
```

**为什么**
- `codesign`：证明安装包是你发布的
- `notary`：通过 Apple 安全扫描，减少“无法打开”拦截
- `staple`：把公证票据绑定到包体，离线机器也能验证
- `dmg`：用户下载分发更方便

**预计耗时**
- 15-60 分钟（公证可能波动）

**产物（默认在 `dist/`）**
- `即刻译.app`
- `即刻译-notary.zip`
- `即刻译.dmg`

---

### Step D：发布前安装验证（强烈建议）

**做什么**
- 在另一台机器或干净用户环境下载并安装 `dmg`
- 验证以下关键路径：
  - 启动是否被系统拦截
  - 菜单栏是否出现
  - `Alt+X` 翻译热键是否正常
  - 辅助功能权限引导是否正常
  - 替换功能和 `Alt+1/2` 是否正常

**为什么**
- 这是“用户真实环境”最后防线

**预计耗时**
- 15-30 分钟

---

### Step E：发布与公告

**做什么**
- 上传 `即刻译.dmg` 到下载渠道（官网/CDN/GitHub Release）
- 粘贴发布说明（重点：修复点、已知限制、升级建议）

**为什么**
- 用户需要知道值不值得升级，以及升级后变化

**预计耗时**
- 10-20 分钟

---

## 3. 推荐时间周期（你问的“多久”）

### 首次上线（从现在到可公开下载）
- 快速路径：`1-2 天`
- 稳妥路径：`3-5 天`（含更充分测试）

### 后续常规迭代
- 小版本（Bugfix）：`0.5-1 天`
- 中版本（有新功能）：`1-3 天`

### 建议发布节奏
- 早期：每 `1-2 周` 一个小版本
- 稳定后：每 `2-4 周` 一个版本

---

## 4. 上线前检查清单（可复制）

- [ ] 版本号与 Build Number 已更新
- [ ] Debug/Release 构建通过
- [ ] 关键功能手测通过（翻译、气泡、替换、快捷键）
- [ ] `release-macos.sh` 成功完成签名/公证/封装
- [ ] `dist/` 产物存在且时间戳正确
- [ ] 干净环境安装验证通过
- [ ] 发布说明准备完成

---

## 5. 常见失败点与处理

### 5.1 公证失败
- 现象：`notarytool submit` 返回 Invalid
- 处理：
  1. 执行 `xcrun notarytool log <submission-id> --keychain-profile AC_NOTARY` 查看具体原因
  2. 常见是签名不完整、权限声明不一致、包体损坏

### 5.2 用户安装提示“无法验证开发者”
- 原因：未公证/未 stapler/用户下载过程损坏
- 处理：重新跑完整 `release-macos.sh`，并重新上传

### 5.3 快捷键不触发
- 先确认是否仍有旧进程驻留（菜单栏退出后再重开）
- 检查系统是否与其他软件冲突
- 检查设置文件快捷键：`~/.jikeyi-trans/settings.json`

### 5.4 选中文本读取失败
- 原因：辅助功能权限未开启
- 处理：系统设置 -> 隐私与安全性 -> 辅助功能，允许应用

---

## 6. 安全与合规建议（发布前必须过一遍）

- 不要把真实 API Key 写进默认配置或对外截图
- 发布说明里明确：
  - 应用会请求辅助功能权限（用于读取选中内容）
  - 数据如何发送到翻译服务（透明告知）
- 如有官网，建议提供最小版隐私说明页面

---

## 7. 一条命令发布（你后续最常用）

```bash
cd /Volumes/PSSD/工具/trans
APP_VERSION="<版本号>" \
BUILD_NUMBER="$(date +%Y%m%d%H%M)" \
SIGN_IDENTITY="Developer ID Application: <名称> (<TEAMID>)" \
KEYCHAIN_PROFILE="AC_NOTARY" \
./scripts/release-macos.sh
```

这条跑通，你就已经进入“可正式对外分发”状态。
